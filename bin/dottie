#!/usr/bin/env ruby

require_relative "../lib/dottie"
require_relative "../lib/dottie/colour"
require_relative "../lib/dottie/test_case"
require_relative "../lib/dottie/runner"
require_relative "../lib/dottie/type"

puts "✨ Dottie #{Dottie::VERSION} :)\n\n"

exit_code = 0
test_files = Dir["tests/*.*t"]
runner = Dottie::Runner.new

test_files.each do |path|
  sections = {}

  type = Dottie::Type::for(File.extname(path))

  File.open(path) do |file|
    section = nil

    file.each_line do |line|
      matches = /^--([A-Z]+)--$/.match(line)

      if matches
        section = matches[1].downcase.to_sym

        raise "Duplicate '--#{matches[1]}--' section found" if sections.has_key?(section)

        sections[section] = ""

        next
      end

      raise "Must begin a test file with --TEST--" unless section

      sections[section] += line
    end
  end

  test_case = Dottie::TestCase.new(type, runner, **sections)
  success = test_case.run

  exit_code = 1 unless success

  if success
    puts "#{Dottie::Colour.new("✔").green} #{test_case.test}"
  else
    puts "#{Dottie::Colour.new("✖").red} #{test_case.test}"
  end

  unless success
    puts <<-TEXT
  #{Dottie::Colour.new("Expected output:").bold}
#{test_case.expect}
  #{Dottie::Colour.new("Actual output:").bold}
#{test_case.result}
TEXT
  end
end

exit exit_code
