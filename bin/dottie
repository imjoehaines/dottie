#!/usr/bin/env ruby

require_relative "../lib/dottie"
require_relative "../lib/dottie/formatter"
require_relative "../lib/dottie/parser"
require_relative "../lib/dottie/runner"
require_relative "../lib/dottie/test_case"
require_relative "../lib/dottie/type"

puts "âœ¨ Dottie #{Dottie::VERSION} :)\n\n"

runner = Dottie::Runner.new
formatter = Dottie::Formatter.new

results = []
exit_code = 0
directory = ARGV.fetch(0, "tests")
test_files = Dir["#{directory}/*.*t"]

if test_files.empty?
  puts formatter.no_tests_found("#{__dir__}/#{directory}")

  exit 1
end

test_files.each do |path|
  sections = Dottie::Parser.parse(path)
  type = Dottie::Type.for(File.extname(path))

  test_case = Dottie::TestCase.new(type, **sections)
  result = test_case.run(runner)

  puts formatter.test_result(test_case, result)

  exit_code = 1 if result.failed?

  results << result
end

puts formatter.suite_result(results)

exit exit_code
