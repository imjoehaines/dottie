#!/usr/bin/env ruby

require_relative "../lib/dottie"
require_relative "../lib/dottie/colour"
require_relative "../lib/dottie/parser"
require_relative "../lib/dottie/runner"
require_relative "../lib/dottie/test_case"
require_relative "../lib/dottie/type"

puts "✨ Dottie #{Dottie::VERSION} :)\n\n"

exit_code = 0
test_files = Dir["tests/*.*t"]
runner = Dottie::Runner.new

test_files.each do |path|
  sections = Dottie::Parser.parse(path)
  type = Dottie::Type.for(File.extname(path))

  test_case = Dottie::TestCase.new(type, **sections)
  result = test_case.run(runner)

  if result.success?
    puts "#{Dottie::Colour.new("✔").green} #{test_case.test}"
  elsif result.skipped?
    puts "#{Dottie::Colour.new("-").cyan} #{test_case.test}"
  else
    puts <<~TEXT
      #{Dottie::Colour.new("✖").red} #{test_case.test}
      #{Dottie::Colour.new("Expected output:").bold}
      #{test_case.expect}
      #{Dottie::Colour.new("Actual output:").bold}
      #{test_case.result}
    TEXT

    exit_code = 1
  end
end

exit exit_code
